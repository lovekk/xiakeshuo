<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>å‘å¸ƒæ ¡å›­äºŒæ‰‹</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css"/>

    <style type="text/css">

        html {
            height: 100%;
            background-color: transparent;
        }

        textarea {
            padding: 10px;
            border: 1px solid #ccc;
            color: #000;
            font-size: 16px;
            height: 250px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn {
            margin: 3px 10px;
            background: #457cfa;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            margin-top: 20px;
            border-radius: 20px;
            color: #fff;
        }

        .aui-list .aui-list-item-media {
            width: 3rem;
        }

        .notes-add {
            position: fixed;
            left: 0.5rem;
            bottom: 0.5rem;
            width: 3rem;
            z-index: 99;
        }

        textarea {
            height: 8rem;
            background-color: #ffffff;
            padding: 0.5rem;
        }

        .photos img {
            display: block;
            width: 100%;
        }

        .add-photos > div {
            width: 100%;
            height: 5.15rem;
            line-height: 5.15rem;
        }

        .add-photos > div .aui-iconfont {
            font-size: 2rem;
            color: #ccc;
        }

        .image-item {
            position: relative;
            height: 5.3rem;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        .image-item img {
            display: block;
            margin: 0 auto;
            width: auto;
            height: 100%;
        }

        .image-item .delete-btn {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 28px;
            height: 28px;
            background-color: rgba(0, 0, 0, 0.7);
            margin-left: -14px;
            margin-top: -14px;
            color: #ffffff;
            text-align: center;
            border-radius: 50%;
        }

    </style>
</head>
<body>

<div id="app" class="aui-content">

    <!-- ==================== å¤´éƒ¨ ============================-->
    <header class="aui-bar aui-bar-nav my-bgc">
        <div class="aui-pull-left aui-btn" tapmode onclick="api.closeWin();">
            <span class="aui-iconfont aui-icon-left"></span>
        </div>
        <div class="aui-title">æ ¡å›­äºŒæ‰‹</div>

    </header>


    <!-- ===================== æ–‡æœ¬ ============================-->
    <section class="aui-content-padded">
        <textarea placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥å†…å®¹...(120å­—ä»¥å†… å¯ä»¥ç•™ä¸‹å…¶ä»–è”ç³»æ–¹å¼ æ–¹ä¾¿ä¹°å®¶è”ç³»)" v-model="content"></textarea>
    </section>

    <section class="aui-list-item aui-content-padded">
        <div class="aui-list-item-inner">
            <label><input class="aui-radio" type="radio" name="radio2" value="0" v-model="is_type" checked>å…¨æ–° &nbsp;&nbsp;&nbsp;</label>
            <label><input class="aui-radio" type="radio" name="radio2" value="1" v-model="is_type"/>ä¹æ–° &nbsp;&nbsp;&nbsp;</label>
            <label><input class="aui-radio" type="radio" name="radio2" value="2" v-model="is_type"/>åŠæ–°</label>
        </div>
        <br>
        <div class="aui-list-item aui-list-item-inner">
            <div class="aui-list-item-input">
                <input type="number" placeholder="è¯·è¾“å…¥ä»·æ ¼(å…ƒ)" v-model="price">
            </div>
        </div>
    </section>

    <!-- ==================== é…å›¾ ============================-->
    <section class="aui-content-padded">
        <div style="font-size: 14px;color: #9e9e9e">
            *æœ€å¤šä¸Šä¼ 9å¼ ï¼Œæˆ‘ä»¬æœ‰çš„å›¾ç‰‡ä¼šæ—‹è½¬å“¦<br>
            *ä¸æ˜¯æ‰‹æœºé—®é¢˜ï¼Œæ˜¯æˆ‘ä»¬è¿™ä¸ªæ—‹è½¬bugè¿˜æ²¡è§£å¼€ğŸ˜‚
        </div>
        <div class="aui-row aui-row-padded">
            <div v-if="img_list">
                <div class="aui-col-xs-4 image-item" v-for="item in img_list">
                    <img :src=" item " class="notes-image">
                    <div class="delete-btn">
                        <i class="aui-iconfont aui-icon-trash" v-on:click="del_img( item )"></i>
                    </div>
                </div>
            </div>
            <div v-if=" list_len < 9 ">
                <div class="aui-col-xs-4 add-photos" style="border: #c7c7c7 1px solid" onclick="UIAlbumBrowser_open()">
                    <div class="aui-border aui-text-center">
                        <i class="aui-iconfont aui-icon-camera "></i>
                    </div>
                </div>
            </div>

        </div>
        <br>
    </section>

    <div class="btn" tapmode v-on:click="add_second();">å®Œæˆ</div>
    <br><br><br>
</div>

</body>

<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/vue.js"></script>

<script type="text/javascript">

    var UIAlbumBrowser; //ä¸Šä¼ å›¾ç‰‡æ¨¡å—å®ä¾‹
    apiready = function () {

        $api.fixIos7Bar($api.dom("header"));//padding-top: 20px; æ²‰æµ¸å¼çŠ¶æ€æ 
        UIAlbumBrowser = api.require('UIAlbumBrowser'); //ä¸Šä¼ å›¾ç‰‡æ¨¡å—å®ä¾‹

        //æ¥æ”¶å‚æ•°
        vm.school_id = api.pageParam.school_id;

    };


    //vueå®ä¾‹
    var vm = new Vue({
        el: '#app',
        data: {
            school_id: '',
            content: '',
            is_type: 1,  //é»˜è®¤1 ä¹æ–°
            price: '',  //ä»·æ ¼
            img_list: [],
            list_len: 0,  //æ§åˆ¶å›¾ç‰‡ä¸Šä¼  å¼ æ•°
        },
        methods: {
            //åˆå§‹åŒ– ajaxæ•°æ®è¯·æ±‚
            add_second: function () {
                if ($api.trimAll(vm.content) === '') {
                    alert('å°å¯çˆ±ï¼Œå¿˜è®°å¡«å†™å†…å®¹å•¦ã€‚');
                    return false;
                }
                if (vm.content.length >= 200) {
                    alert('å°å¯çˆ±ï¼Œå†…å®¹è¦åœ¨200å­—ä»¥å†…ã€‚');
                    return false;
                }
                if (vm.price === '') {
                    alert('å°å¯çˆ±ï¼Œå¿˜è®°å¡«å†™ä»·æ ¼å•¦ã€‚');
                    return false;
                }
                if (vm.price > 1000 || vm.price < -1000) {
                    alert('ä»·æ ¼åœ¨1000å…ƒä¹‹å†…å‘¦');
                    return false;
                }

                api.showProgress({
                    title: 'æ­£åœ¨å®¡æ ¸ä¸­...',
                    text: 'å…ˆå­¦ä¼šä¹ ...',
                    modal: false
                });


                api.ajax({
                    url: second_add,
                    method: 'post',
                    timeout: 30,
                    dataType: 'json',
                    returnAll: false,
                    data: {
                        //ä»¥è¡¨å•æ–¹å¼æäº¤å‚æ•°ï¼ŒJSONå¯¹è±¡{"field1": "value1"}
                        values: {
                            school_id: vm.school_id,
                            creator_id: $api.getStorage('uid'),
                            content: vm.content,
                            price: vm.price,
                            is_type: vm.is_type,
                        },
                        //ä»¥è¡¨å•æ–¹å¼æäº¤æ–‡ä»¶ï¼ŒJSONå¯¹è±¡{"file": "path"}
                        files: {
                            img_list: vm.img_list,
                        }
                    }
                }, function (ret, err) {
                    if (ret) {
                        if (ret.code === 200) {
                            api.hideProgress();
                            alert('å·²å®Œæˆ');
                            api.closeWin();
                        }
                    } else {
                        api.toast({
                            msg: 'ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·é‡æ–°å‘å¸ƒï¼',
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                });
            },
            del_img: function (ele_) {
                del_ele(ele_, vm.img_list);
                vm.list_len = vm.img_list.length;
            }

        }
    });


    //æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨
    function UIAlbumBrowser_open() {
        var len;
        if (vm.img_list.length < 9) {
            len = 9 - vm.img_list.length;
        }
        UIAlbumBrowser.open({
            max: len,
            type: 'image',   //çº¯å›¾ç‰‡
            isOpenPreview: true,
            classify: true,
            styles: {
                bg: '#000000',
                mark: {
                    position: 'bottom_left',
                    size: 20
                },
                nav: {
                    bg: '#000000',
                    titleColor: '#ffffff',
                    titleSize: 18,
                    cancelColor: '#457cfa',
                    cancelSize: 16,
                    finishColor: '#457cfa',
                    finishSize: 16
                }
            },
            rotation: false  //æ¨ªå±æ— æ•ˆ
        }, function (ret) {
            if (ret) {
                if (ret.eventType === 'confirm') {
                    vm.list_len += ret.list.length;

                    for (i = 0; i < ret.list.length; i++) {
                        if (0 <= ret.list[i].size <= 524288) {                //0.5M åŸå›¾
                            trans_path(ret.list[i].path, 1.0);
                        } else if (524288 <= ret.list[i].size <= 2097152) {  //0.5M-2M å‹ç¼©2/3
                            trans_path(ret.list[i].path, 0.3);
                        } else {                                             //2Mä»¥ä¸Š å‹ç¼©è‡³1/10
                            trans_path(ret.list[i].path, 0.1);
                        }
                    }
                }
            }
        });
    }

     var l_img;
    // å°†ç›¸å†Œå›¾ç‰‡åœ°å€è½¬æ¢ä¸ºå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æœ¬åœ°è·¯å¾„åœ°å€ï¼ˆä¸´æ—¶æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„ï¼‰ï¼Œ
    // ç›¸å†Œå›¾ç‰‡ä¼šè¢«æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œè°ƒç”¨ api.clearCache æ¥å£å¯æ¸…é™¤è¯¥ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
    // ä¸»è¦æ˜¯æ§åˆ¶å›¾ç‰‡çš„è´¨é‡
    // ä¸ºä»€ä¹ˆæœ‰çš„å›¾ç‰‡ä¼šæ—‹è½¬ bug bug bug bug bug bug bug bug bug bug bug bug bug
    function trans_path(img_, scale_) {
        UIAlbumBrowser.transPath({
            path: img_,
            scale: scale_
        }, function(ret, err) {
            if (ret) {
                // return ret.path
                l_img = ret.path;
                vm.img_list.push(l_img);
            } else {
                alert('å°å¯çˆ±ï¼Œä½ ä¸Šä¼ çš„å›¾ç‰‡è¿‡å¤§äº†ã€‚');
            }
        });
    }

</script>

</html>
