<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>å‘å¸ƒ</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../css/alifont/iconfont.css"/>

    <style type="text/css">

        html {
            height: 100%;
            background-color: transparent;
        }

        textarea {
            padding: 10px;
            border: 1px solid #ccc;
            color: #000;
            font-size: 16px;
            height: 250px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn {
            margin: 3px 10px;
            background: #457cfa;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            margin-top: 20px;
            border-radius: 20px;
            color: #fff;
        }

        .aui-list .aui-list-item-media {
            width: 3rem;
        }

        textarea {
            height: 8rem;
            background-color: #ffffff;
            padding: 0.5rem;
        }

        .photos img {
            display: block;
            width: 100%;
        }

        .add-photos > div {
            width: 100%;
            height: 5.15rem;
            line-height: 5.15rem;
        }

        .add-photos > div .aui-iconfont {
            font-size: 2rem;
            color: #ccc;
        }

        .image-item {
            position: relative;
            height: 5.3rem;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        .image-item img {
            display: block;
            margin: 0 auto;
            width: auto;
            height: 100%;
        }

        .image-item .delete-btn {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 28px;
            height: 28px;
            background-color: rgba(0, 0, 0, 0.7);
            margin-left: -14px;
            margin-top: -14px;
            color: #ffffff;
            text-align: center;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<div id="app" class="aui-content">

    <header class="aui-bar aui-bar-nav my-bgc">
        <div class="aui-pull-left aui-btn" tapmode onclick="api.closeWin();">
            <span class="aui-iconfont aui-icon-left"></span>
        </div>
        <div class="aui-title">å‘å¸ƒ</div>
    </header>

    <!--=================================æ–‡æœ¬=============================-->

    <!--<p class="aui-text-center aui-margin-t-15">å†…å®¹å‘å¸ƒ</p>-->
    <section class="aui-content-padded">
        <textarea placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹...(300å­—ä»¥å†…)" v-model="content"></textarea>
    </section>
    <!--<p class="aui-text-center aui-margin-t-15">è¯­éŸ³</p>-->

    <!--<section class="aui-content-padded" v-if="is_show">-->
        <!--<div class="aui-row aui-row-padded" style="text-align: center">-->
            <!--<div class="aui-col-xs-4" onclick="open_audio()">-->
                <!--<div class="aui-btn aui-btn-info">éŸ³é¢‘</div>-->
            <!--</div>-->
            <!--<div class="aui-col-xs-4" onclick="img_open()">-->
                <!--<div class="aui-btn aui-btn-info">å›¾ç‰‡</div>-->
            <!--</div>-->
            <!--<div class="aui-col-xs-4" onclick="video_open()">-->
                <!--<div class="aui-btn aui-btn-info">è§†é¢‘</div>-->
            <!--</div>-->
        <!--</div>-->
    <!--</section>-->

    <section class="aui-content-padded" v-if="is_show">
        <div class="aui-row" style="text-align: center;">
            <div class="aui-col-xs-4" tapmode onclick="open_audio()">
                <i style="color:#039be5;font-size: 35px" class="aui-iconfont iconfont icon-luyin"></i>
            </div>
            <div class="aui-col-xs-4" tapmode onclick="img_open()">
                <i style="color:#71400b;font-size: 35px" class="aui-iconfont iconfont icon-tupian2"></i>
            </div>
            <div class="aui-col-xs-4" tapmode onclick="video_open()">
                <i style="color: #6AB494;font-size: 39px" class="aui-iconfont iconfont icon-shipin2"></i>
            </div>
        </div>
    </section>


    <!--=================================å¤šåª’ä½“ æ˜¾ç¤º=============================-->

    <!-- éŸ³é¢‘ -->
    <section class="aui-content-padded" v-if="is_voice_con">
        <div class="aui-row aui-row-padded">
            <div class="aui-col-xs-3">
                <div><img src="../image/luyin.png"></div>
            </div>
            <div class="aui-col-xs-3">
                <div style="font-size: 14px;color: #9e9e9e;padding-top: 5px">
                    å…±:{{voice_time}}S
                </div>
            </div>
            <div class="aui-col-xs-3" onclick="paly_audio()">
                <div class="aui-btn aui-btn-primary">{{play_s}}</div>
            </div>
            <div class="aui-col-xs-3" onclick="del_audio()">
                <div class="aui-btn aui-btn-danger">åˆ é™¤</div>
            </div>
        </div>
    </section>

    <!-- å›¾ç‰‡ -->
    <section class="aui-content-padded" v-if="is_img_con">
        <div class="aui-row aui-row-padded">
            <div class="aui-col-xs-4 image-item" v-for="item in img_list">
                <img :src=" item " class="notes-image">
                <div class="delete-btn">
                    <i class="aui-iconfont aui-icon-trash" v-on:click="del_img( item )"></i>
                </div>
            </div>
            <div v-if=" list_len < 9 ">
                <div class="aui-col-xs-4 add-photos" style="border: #c7c7c7 1px solid" onclick="img_open()">
                    <div class="aui-border aui-text-center">
                        <i class="aui-iconfont aui-icon-camera "></i>
                    </div>
                </div>
            </div>
        </div>



    </section>

    <!-- çŸ­è§†é¢‘ -->
    <section class="aui-content-padded" v-if="is_video_con">
        <div class="aui-row aui-row-padded">
            <div class="aui-col-xs-4 image-item">
                <img :src=" video_img " class="notes-image">
                <div class="delete-btn" onclick="del_video()">
                    <i class="aui-iconfont aui-icon-trash"></i>
                </div>
            </div>
        </div>
    </section>

    <br>
    <!--=================================è¯é¢˜=============================-->


    <section class="aui-content-padded" style="margin-top: 0;">
        <div class="">
            <span>
                <label><input style="color:#1874CD" type="text" v-model="topic"></label>
            </span>
        </div>
        <div class="aui-card-list" style="background-color: #f5f5f5">
            <div class="">
                <span style="font-size: 16px;color: #616161;font-weight: bolder">è¯é¢˜ï¼š</span>
                <span v-for="item in topic_list" style="padding-right: 10px"
                      v-on:click="choose_topic(item.name)">
                    #{{item.name}}#
                </span>
            </div>
        </div>
    </section>

    <!--========================åŒæ­¥å…¨å›½============================-->
    <section class="aui-list-item aui-content-padded">
        <div class="aui-list-item-inner">
            <label><input class="aui-radio" type="checkbox" checked> &nbsp;åŒæ­¥å…¨å›½</label>
        </div>
    </section>

    <!--=================================å®Œæˆ=============================-->
    <div class="btn" tapmode v-on:click="fn_submit();">å®Œæˆ</div>
    <br>
    <section class="aui-content-padded">
        <!--<div style="color: #9e9e9e;font-size: 14px">-->
            <!--*æ³¨ï¼šè¯é¢˜æ ‡ç­¾ï¼Œç‚¹å‡»è‡ªåŠ¨å½•å…¥ï¼›<br>-->
            <!--å›¾ç‰‡æœ€å¤šåŒæ—¶ä¸Šä¼ 9å¼ ï¼›<br>-->
            <!--éŸ³é¢‘æœ€å¤šä¸Šä¼ 1ä¸ªï¼Œ120sä»¥å†…ï¼›<br>-->
            <!--è§†é¢‘æœ€å¤šä¸Šä¼ 1ä¸ªï¼Œ10Mä»¥å†…ï¼›<br>-->
            <!--<br>-->
            <!--ğŸ’—å¥½å¥½å­¦ä¹  &nbsp; å¤©å†·åŠ è¡£ğŸ’—-->
        <!--</div>-->
    </section>
    <br>
</div>


</body>


<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/vue.js"></script>

<script type="text/javascript">


    var UIAlbumBrowser;
    apiready = function () {

        $api.fixIos7Bar($api.dom("header"));//padding-top: 20px; æ²‰æµ¸å¼çŠ¶æ€æ 
        UIAlbumBrowser = api.require('UIAlbumBrowser'); //ä¸Šä¼ å›¾ç‰‡æ¨¡å—å®ä¾‹

        //æ¥æ”¶å‚æ•°
        vm.school_id = api.pageParam.school_id;
        vm.school_name = api.pageParam.school_name;
        vm.init(); //è·å–è¯é¢˜æ ‡ç­¾

    };


    //vueå®ä¾‹
    var vm = new Vue({
        el: '#app',
        data: {
            school_id: '',
            school_name: '',

            is_show: 1,  //æŒ‰é’®çŠ¶æ€
            is_img_con: 0,  //éŸ³è§†å›¾å†…å®¹çŠ¶æ€
            is_video_con: 0,
            is_voice_con: 0,

            content: '',   //æ–‡æœ¬
            topic_list: [],  //è¯é¢˜æ ‡ç­¾
            topic: '',

            img_list: [],  //å›¾ç‰‡
            list_len: '',

            voice_url: '',  //éŸ³é¢‘
            voice_time: '',
            play_s: 'æ’­æ”¾',

            video_url: '',  //è§†é¢‘
            video_img: '',
            video_size: '',

        },
        methods: {
            //åˆå§‹åŒ– ajaxæ•°æ®è¯·æ±‚
            //è·å–è¯é¢˜æ ‡ç­¾
            init: function () {
                api.ajax({
                    url: tag_list,
                    method: 'get',
                    cache: 'true',
                    timeout: 30,
                    dataType: 'json',
                    returnAll: false,
                }, function (ret, err) {
                    if (ret) {
                        vm.topic_list = ret.tag;  //è¯é¢˜æ ‡ç­¾
                    } else {
                        my_toast();
                    }
                });
            },

            //æäº¤ ajaxæ•°æ®
            fn_submit: function () {
                api.showProgress({
                    title: 'æ­£åœ¨å®¡æ ¸ä¸­...',
                    text: 'å…ˆå­¦ä¼šä¹ ...',
                    modal: false
                });
                api.ajax({
                    url: moment_add,
                    method: 'post',
                    timeout: 30,
                    dataType: 'json',
                    returnAll: false,
                    data: {
                        //ä»¥è¡¨å•æ–¹å¼æäº¤å‚æ•°ï¼ŒJSONå¯¹è±¡{"field1": "value1"}
                        values: {
                            school_id: vm.school_id,  //æ–‡æœ¬å†…å®¹
                            creator_id: $api.getStorage('uid'),
                            content: vm.content,
                            tag: vm.topic,

                            voice_time: vm.voice_time,  //å¤šåª’ä½“å‚æ•°
                            video_size: vm.video_size,
                        },
                        //ä»¥è¡¨å•æ–¹å¼æäº¤æ–‡ä»¶ï¼ŒJSONå¯¹è±¡{"file": "path"}
                        files: {
                            img_list: vm.img_list,
                            voice_url: vm.voice_url,
                            video_url: vm.video_url,
                        }
                    }
                }, function (ret, err) {
                    if (ret) {
                        if (ret.code === 200){
                            api.hideProgress();
                            //å®Œæˆå åˆ·æ–°è¯¦æƒ…é¡µ
                            api.execScript({
                                name: 'root',
                                frameName: 'frame1',
                                script: 'come_on();'
                            });
                            alert('å‘å¸ƒæˆåŠŸï¼');
                            api.closeWin();
                        }
                    }
                    else {
                        api.toast({
                            msg: 'ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·é€€å‡ºé‡æ–°å‘å¸ƒï¼',
                            duration: 3000,
                            location: 'bottom'
                        });
                    }
                });
            },

            //é€‰æ‹©æ ‡ç­¾
            choose_topic: function (topic_) {
               vm.topic = topic_
            },

            //åˆ é™¤å›¾ç‰‡
            del_img: function (ele_) {
                del_ele(ele_, vm.img_list);
                vm.list_len = vm.img_list.length;
                if (vm.img_list.length === 0) {
                    vm.is_show = 1;  // å›¾ç‰‡ä¸º0 æ˜¾ç¤ºæŒ‰é’®

                    vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                    vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                    vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€

                }
            }
        }
    });


    //==========================================å›¾ç‰‡================================
    //æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨
    function img_open() {
        var len;
        if (vm.img_list.length < 9) {
            len = 9 - vm.img_list.length;
        }
        UIAlbumBrowser.open({
            max: len,
            type: 'image',   //çº¯å›¾ç‰‡
            isOpenPreview: true,
            classify: true,
            styles: {
                bg: '#000000',
                mark: {
                    position: 'bottom_left',
                    size: 20
                },
                nav: {
                    bg: '#000000',
                    titleColor: '#ffffff',
                    titleSize: 18,
                    cancelColor: '#00ff00',
                    cancelSize: 16,
                    finishColor: '#00ff00',
                    finishSize: 16
                }
            },
            rotation: false  //æ¨ªå±æ— æ•ˆ
        }, function (ret) {
            if (ret) {
                if (ret.eventType === 'confirm') {
                    vm.list_len += ret.list.length;

                    for (i = 0; i < ret.list.length; i++) {
                        if (0 <= ret.list[i].size <= 524288) {                //0.5M åŸå›¾
                            trans_path(ret.list[i].path, 1.0);
                        } else if (524288 <= ret.list[i].size <= 2097152) {  //0.5M-2M å‹ç¼©2/3
                            trans_path(ret.list[i].path, 0.3);
                        } else {                                             //2Mä»¥ä¸Š å‹ç¼©è‡³1/10
                            trans_path(ret.list[i].path, 0.1);
                        }
                    }

                }else {
                    if (vm.img_list.length === 0) {
                        vm.is_show = 1;   // å›¾ç‰‡ä¸º0 æ˜¾ç¤ºæŒ‰é’®

                        vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                        vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                        vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€
                    }
                }

            }
        });
    }


    var l_img;
    // å°†ç›¸å†Œå›¾ç‰‡åœ°å€è½¬æ¢ä¸ºå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æœ¬åœ°è·¯å¾„åœ°å€ï¼ˆä¸´æ—¶æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„ï¼‰ï¼Œ
    // ç›¸å†Œå›¾ç‰‡ä¼šè¢«æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œè°ƒç”¨ api.clearCache æ¥å£å¯æ¸…é™¤è¯¥ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
    // ä¸»è¦æ˜¯æ§åˆ¶å›¾ç‰‡çš„è´¨é‡
    // ä¸ºä»€ä¹ˆæœ‰çš„å›¾ç‰‡ä¼šæ—‹è½¬ bug bug bug bug bug bug bug bug bug bug bug bug bug
    function trans_path(img_, scale_) {
        UIAlbumBrowser.transPath({
            path: img_,
            scale: scale_
        }, function(ret, err) {
            if (ret) {
                l_img = ret.path;
                vm.img_list.push(l_img);

                if (vm.img_list.length >= 1) {
                    vm.is_show = 0;   // å›¾ç‰‡>1 éšè—æŒ‰é’®

                    vm.is_img_con = 1; //å›¾ å†…å®¹çŠ¶æ€
                    vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                    vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€
                }
            } else {
                api.toast({
                    msg: 'å›¾ç‰‡å¯èƒ½è¿‡å¤§ï¼Œå‡ºç°é”™è¯¯',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }


    //==========================================å½•éŸ³================================
    //å½•éŸ³çª—å£
    function open_audio() {
        api.openWin({
            name: 'find_add_audio',
            url: './find_add_audio.html',
            pageParam: {
                voice: 'f_voice'
            }
        });
    }


    //æ¥æ”¶å½•éŸ³å‚æ•°
    function voice_par(voice_, time_) {
        vm.voice_url = voice_;
        vm.voice_time = time_;
        if (vm.voice_url && vm.voice_time) {
            vm.is_show = 0;  //å½•éŸ³æˆåŠŸ éšè—æŒ‰é’®

            vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
            vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
            vm.is_voice_con = 1; //éŸ³ å†…å®¹çŠ¶æ€
        }
    }


    //æ’­æ”¾å½•éŸ³
    function paly_audio() {
        vm.play_s = 'æ’­æ”¾ä¸­...';
        api.startPlay({
            path: vm.voice_url
        }, function (ret, err) {
            if (ret) {
                vm.play_s = 'æ’­æ”¾å®Œæˆ';
            } else {
                vm.play_s = 'æ’­æ”¾é”™è¯¯';
            }
        });
    }


    //åˆ é™¤å½•éŸ³
    function del_audio() {
        api.confirm({
            title: 'æç¤º',
            msg: 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
            buttons: ['ç¡®å®š', 'å–æ¶ˆ']
        }, function(ret, err) {
            if (ret.buttonIndex === 1) {
                vm.voice_url = '';
                vm.voice_time = '';

                vm.is_show = 1;  //å½•éŸ³åˆ é™¤ æ˜¾ç¤ºæŒ‰é’®

                vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€
            }

        });
    }


    //==========================================è§†é¢‘================================
    //æ‰“å¼€è§†é¢‘é€‰æ‹©å™¨
    function video_open() {
        UIAlbumBrowser.open({
            max: 1,
            type: 'video',   //çº¯è§†é¢‘
            isOpenPreview: true,
            classify: true,
            styles: {
                bg: '#000000',
                mark: {
                    position: 'bottom_left',
                    size: 20
                },
                nav: {
                    bg: '#000000',
                    titleColor: '#ffffff',
                    titleSize: 18,
                    cancelColor: '#00ff00',
                    cancelSize: 16,
                    finishColor: '#00ff00',
                    finishSize: 16
                }
            },
            rotation: false  //æ¨ªå±æ— æ•ˆ
        }, function (ret) {
            if (ret) {
                if (ret.eventType === 'confirm') {
                    //è¿™è¾¹è®¾ç½®çš„è§†é¢‘æœ€å¤§å€¼
                    //è¿™è¾¹è®¾ç½®çš„è§†é¢‘æœ€å¤§å€¼
                    //è¿™è¾¹è®¾ç½®çš„è§†é¢‘æœ€å¤§å€¼
                    var v_s = ret.list[0].size/1048576;
                    if (v_s >= 30) {
                        alert('æ‚¨çš„çŸ­è§†é¢‘è¿‡å¤§äº†å“¦ï¼(30Mä»¥å†…)');
                        return false
                    }

                    if (ret.list[0].videoPath) {
                        vm.video_url = ret.list[0].videoPath;
                        vm.video_img = ret.list[0].thumbPath;
                        vm.video_size = ret.list[0].size / 1048576;
                    }

                    if (vm.video_url) {
                        vm.is_show = 0;   // è§†é¢‘æœ‰ éšè—æŒ‰é’®
                        vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                        vm.is_video_con = 1; //è§† å†…å®¹çŠ¶æ€
                        vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€
                    }

                }else {
                    if (vm.video_url === '') {
                        vm.is_show = 1;   // è§†é¢‘ä¸º0 æ˜¾ç¤ºæŒ‰é’®
                        vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                        vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                        vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€
                    }
                }

            }
        });
    }


    //åˆ é™¤è§†é¢‘
    function del_video() {
        api.confirm({
            title: 'æç¤º',
            msg: 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
            buttons: ['ç¡®å®š', 'å–æ¶ˆ']
        }, function(ret, err) {
            if (ret.buttonIndex === 1) {
                vm.video_url = '';  //ç½®ç©ºè§†é¢‘æ•°æ®
                vm.video_img = '';
                vm.video_size = '';

                vm.is_show = 1;  //è§†é¢‘åˆ é™¤ æ˜¾ç¤ºæŒ‰é’®

                vm.is_img_con = 0; //å›¾ å†…å®¹çŠ¶æ€
                vm.is_video_con = 0; //è§† å†…å®¹çŠ¶æ€
                vm.is_voice_con = 0; //éŸ³ å†…å®¹çŠ¶æ€

            }

        });
    }





</script>

</html>
